---
import Layout from '../components/Layout.astro';
import DocumentHead from '../components/DocumentHead.astro';
import { InferGetStaticParamsType, InferGetStaticPropsType } from 'astro';
import TagsList from '../components/TagsList.astro';
import { getCollection, getEntry } from 'astro:content';
import CommentsList from '../components/CommentsList.astro';

export async function getStaticPaths() {
  const notes = await getCollection('notes');
  return notes.map((note) => ({
    params: { slug: note.slug },
    props: { note },
  }));
}

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
type Props = InferGetStaticPropsType<typeof getStaticPaths>;

export function formatDate(date) {
  return new Date(date.replace(/-/g, '/')).toLocaleDateString('en-US', {
    month: 'long',
    day: 'numeric',
    year: 'numeric',
  });
}

const { slug } = Astro.params;
const { note } = Astro.props;

if (slug === undefined) return;

const commentsEntry = await getEntry('comments', slug);
const comments = commentsEntry?.data?.comments || [];

console.log(comments);

const { Content } = await note.render();

const {
  data: { title, added, updated, tags, excerpt },
} = note;

// random imageId between 1 and 6
const imageId = Math.floor(Math.random() * 6) + 1;

let description = excerpt;
let permalink = `https://rachsmith.com/${slug}/`;

const titleEncoded = encodeURIComponent(`re: ${title}`);
const tweetTextEncoded = encodeURIComponent(
  `re: https://rachsmith.com/${slug}`
);
---

<style>
  h1 {
    font-size: 2.5rem;
    margin-bottom: 0;
    line-height: 1;
  }

  .meta {
    margin: 2em 0;
    padding: 0.5em 0;
    border-top: 1px dashed var(--text-color);
    color: var(--second-text-color);
  }

  .meta .tags {
    list-style: none;
    display: flex;
    margin: 0;
    padding: 0;
  }

  .meta .added-updated {
    font-size: 0.9em;
    text-transform: uppercase;
  }
</style>

<html lang="en">
  <DocumentHead
    title={title}
    description={description ?? ''}
    permalink={permalink}
    canonicalUrl={permalink}
    imageId={imageId}
  />
  <body>
    <Layout page="note">
      <article>
        <h1 class="title">{title}</h1>
        <div class="meta">
          <span class="added-updated"
            >Added: {formatDate(added)}{
              updated !== added && `, Updated: ${formatDate(updated)}`
            }</span
          >

          <TagsList tags={tags.map((t) => ({ name: t }))} />
        </div>
        <div class="styled-link-underlines">
          <Content />
        </div>
        <p class="styled-link-underlines">
          <b>Thanks for reading!</b> If you'd like to share your thoughts you can
          <a href={`https://rachsmith.com/${slug}#comments`}>leave a comment</a
          >, <a href={`mailto:contact@rachsmith.com?subject=${titleEncoded}`}
            >send me an email</a
          >, <a
            href={`https://twitter.com/intent/tweet?screen_name=rachsmithtweets&text=${tweetTextEncoded}`}
            >Tweet at me</a
          >, or <a href="https://github.com/rachsmithcodes/rachsmith.com/issues"
            >add an issue on GitHub</a
          >.
        </p>
      </article>
      <section class="comments">
        <h2>Comments</h2>
        <CommentsList parentId={null} allComments={comments} startIndex={Math.floor(Math.random() * 6)} />
      </section>
    </Layout>
  </body>
</html>
